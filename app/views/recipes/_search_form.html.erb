<div class="card border-0 shadow-sm">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-funnel me-2"></i><%= title || "Search Recipes" %>
    </h5>

    <!-- Determine action URL based on context -->
    <% form_action = turbo_frame_context ? recipes_path : search_recipes_path %>
    <% form_data_attrs = turbo_frame_context ? { controller: "turbo", action: "submit->turbo#submitForm" } : {} %>

    <form action="<%= form_action %>" method="get" <% if turbo_frame_context %>data-controller="turbo" data-action="submit->turbo#submitForm"<% end %>>
      <!-- Preserve category if present -->
      <% if params[:category].present? %>
        <input type="hidden" name="category" value="<%= params[:category] %>">
      <% end %>
      
      <div class="row">
        <!-- Recipe Name Search -->
        <div class="col-md-4 mb-3">
          <label for="search_query" class="form-label fw-semibold">Recipe Name</label>
          <input type="text" class="form-control" id="search_query" name="q"
                 value="<%= params[:q] %>" placeholder="e.g., pasta, chicken curry">
        </div>

        <!-- Ingredient Search -->
        <div class="col-md-4 mb-3">
          <label for="search_ingredients" class="form-label fw-semibold">Ingredients</label>
          <input type="text" class="form-control" id="search_ingredients" name="ingredients"
                 value="<%= (defined?(@ingredients) && @ingredients.present?) ? @ingredients.join(', ') : params[:ingredients] %>"
                 placeholder="e.g., chicken, tomatoes, onions">
          <div class="form-text">Separate multiple ingredients with commas</div>
        </div>

        <!-- Search Type -->
        <div class="col-md-4 mb-3">
          <label for="search_type" class="form-label fw-semibold">Search Type</label>
          <select class="form-select" id="search_type" name="search_type">
            <option value="all" <%= 'selected' if (defined?(@search_type) && @search_type == 'all') || params[:search_type] == 'all' || params[:search_type].blank? %>>
              Must have ALL ingredients
            </option>
            <option value="any" <%= 'selected' if (defined?(@search_type) && @search_type == 'any') || params[:search_type] == 'any' %>>
              Can have ANY ingredients
            </option>
          </select>
          <div class="form-text">How to match ingredients</div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search me-2"></i>Search Recipes
        </button>
        <% if turbo_frame_context %>
          <%= link_to "Clear All", recipes_path, class: "btn btn-outline-secondary", data: { action: "click->turbo#getTurboStream" } %>
        <% else %>
          <%= link_to "Clear All", search_recipes_path, class: "btn btn-outline-secondary" %>
        <% end %>
        <% if show_browse_all %>
          <%= link_to "Browse All", recipes_path, class: "btn btn-outline-primary" %>
        <% end %>
      </div>
    </form>

    <!-- Popular Categories (only show on index page) -->
    <% if show_categories && defined?(@popular_categories) && @popular_categories.present? %>
      <hr class="my-4">
      <div class="row">
        <div class="col-12">
          <label class="form-label fw-semibold">Popular Categories</label>
          <div class="d-flex flex-wrap gap-2" data-controller="turbo">
            <%= link_to "All", recipes_path, 
                class: "btn #{'btn-primary' if params[:category].blank?} #{'btn-outline-primary' unless params[:category].blank?} btn-sm",
                data: { action: "click->turbo#getTurboStream" } %>
            <% @popular_categories.each do |category| %>
              <%= link_to category, recipes_path(category: category), 
                  class: "btn #{'btn-primary' if params[:category] == category} #{'btn-outline-primary' unless params[:category] == category} btn-sm",
                  data: { action: "click->turbo#getTurboStream" } %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
